# GORewrite エクスポート切り取り仕様書

## 基本原則
1. **碁盤の端（1路、19路など）**: 線の通りで切り抜く
2. **盤端以外の部分**: マス目の中間（線と線の間）で切り抜く

## 設計理由
- 部分図では罫線が選択範囲の端まで伸びる（石の外側にも線が見える）
- 碁盤全体なのか部分図なのかを明確に見分けられる
- 罫線が途中で切れていることで、図が碁盤の一部であることが視覚的に分かる
- **線でぴったり切り抜くと、小さい碁盤の全体図と間違えてしまう**

## 用語定義
| 用語 | 説明 |
|------|------|
| 選択範囲 | ユーザーがドラッグで指定した行・列の範囲 (例: rowX〜rowY, colA〜colB) |
| 余白 (PADDING) | 選択範囲の端から切り取り位置までの距離 (= CELL_SIZE / 2 = 20px) |
| 罫線 | 碁盤の縦横の線。交点に石が置かれる |
| 凡例 | 隠れた着手番号を表示するフッター領域 (例: "3 [A]") |

## 切り取り位置の計算

### 基本公式
```
切り取り端 = 最端の罫線位置 + 余白 (PADDING)
```

### 具体例 (選択範囲: row 5〜10)
- row 5 の中心Y座標: `MARGIN + (5-1) * CELL_SIZE` = 200
- row 10 の中心Y座標: `MARGIN + (10-1) * CELL_SIZE` = 400
- **上端切り取り位置**: 200 - 20 = **180** (線の間)
- **下端切り取り位置**: 400 + 20 = **420** (線の間)

```
  Row 4 ──────────────────  y=160
        ↑
        │  20px (上端余白は含まない)
        ↓
┌ 切り取り上端 ──────────────  y=180 (線の間) ─┐
│                                              │
│ Row 5 ──────────────────  y=200              │
│                                              │
│ Row 6 ──────────────────  y=240              │
│       ...                                    │
│ Row 10 ─────────────────  y=400              │
│                                              │
│       ↓ 20px (余白)                          │
└ 切り取り下端 ─────────────  y=420 (線の間) ─┘
        ↑
        │  20px (下端余白は含まない)
        ↓
  Row 11 ─────────────────  y=440
```

## 凡例がある場合の動作

### 期待動作
1. **選択範囲の切り取り位置は変更しない** (y=420のまま)
2. 切り取り位置以下の罫線は**背景色で隠す**
3. 凡例は隠された領域に描画する

### 視覚的な結果
```
┌ 切り取り上端 ──────────────  y=180 ──────────┐
│                                              │
│ [碁盤・石・罫線が表示される領域]             │
│                                              │
├ 切り取り下端 ─────────────  y=420 ──────────┤
│ ████████████████████████████████████████████ │ ← 背景色マスク
│                                              │
│       3 [ A ]  ← 凡例                        │
│                                              │
└──────────────────────────────────────────────┘
```

## 現在のバグ
凡例がある場合、下端の切り取り位置が**罫線に合わせて変更される**。

- 期待: y=420 (線の間)
- 実際: y=440 (線の上) ← **不正**

## 修正方針
1. `coverRect` (マスク) の位置を切り取り位置 (y=420) に正確に配置
2. viewBox拡張時も切り取り位置を変更しない
3. マスクが確実に罫線を隠すよう、要素の重なり順を確認
